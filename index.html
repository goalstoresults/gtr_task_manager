<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GTR Task Manager v1.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background: #f6f7f9; margin: 0; padding: 20px; }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.1); display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .badge { background: #eef2ff; color: #3730a3; border-radius: 8px; padding: 4px 8px; font-size: 14px; }
    .btn { text-decoration: none; background: #111827; color: white; padding: 8px 12px; border-radius: 8px; }
    select { padding: 6px; border-radius: 6px; border: 1px solid #ccc; }
    .panel { margin-top: 16px; }
    iframe { width: 100%; height: 70vh; border: 1px solid #e5e7eb; border-radius: 12px; background:#fff; }
  </style>
</head>
<body>
  <div class="card">
    <strong>GTR Task Manager v1.4</strong>
    <span id="modeBadge" class="badge"></span>

    <label>Client</label>
    <select id="clientSelect"></select>

    <label>View</label>
    <select id="viewSelect">
      <option value="active" selected>Active</option>
      <option value="attention">Attention</option>
    </select>

    <a id="addTaskBtn" class="btn" href="#">Add Task</a>
    <a id="openInNewTab" class="btn" href="#" target="_blank" rel="noopener">Open List</a>
  </div>

  <div class="panel">
    <iframe id="listFrame" src="about:blank"></iframe>
  </div>

  <script>
    // === CONFIG ===
    const GTR_ID = "hezFHREjxhfwcOdxYOcc";
    const WORKER_BASE = "https://gtr-task-add.dennis-e64.workers.dev";

    // === STATE ===
    const url = new URL(window.location.href);
    const cid = (url.searchParams.get("cid") || "").trim();
    const adminFlag = url.searchParams.get("admin") === "1";
    const isAdmin = adminFlag || (cid === (GTR_ID || "").trim());

    // === ELEMENTS ===
    const clientSelect = document.getElementById("clientSelect");
    const viewSelect   = document.getElementById("viewSelect");
    const modeBadge    = document.getElementById("modeBadge");
    const addTaskBtn   = document.getElementById("addTaskBtn");
    const openInNewTab = document.getElementById("openInNewTab");
    const listFrame    = document.getElementById("listFrame");

    // === INIT ===
    if (!cid) {
      modeBadge.textContent = "Missing cid";
      clientSelect.innerHTML = '<option value="">(cid required in URL)</option>';
      clientSelect.disabled = true;
    } else if (isAdmin) {
      modeBadge.textContent = "Admin mode";
      loadClientOptions();
    } else {
      modeBadge.textContent = "Client view";
      loadSingleClientLabel(cid);
      clientSelect.disabled = true;
    }

    // Wire main actions
    addTaskBtn.href   = `${WORKER_BASE}/new?cid=${encodeURIComponent(cid)}${isAdmin ? '&admin=1' : ''}`;
    openInNewTab.href = buildTasksUrl(viewSelect.value, cid, isAdmin);

    // Load initial list
    setListSrc();

    // === FUNCTIONS ===
    function buildTasksUrl(view, cid, keepAdmin) {
      const a = keepAdmin ? "&admin=1" : "";
      return `${WORKER_BASE}/tasks?view=${encodeURIComponent(view)}&cid=${encodeURIComponent(cid)}${a}`;
    }

    function setListSrc() {
      if (!cid) return;
      const view = viewSelect.value || "active";
      const src = buildTasksUrl(view, cid, isAdmin);
      listFrame.src = src;
      openInNewTab.href = src;
    }

    viewSelect.addEventListener("change", setListSrc);

    async function loadClientOptions() {
      try {
        // Always ask the Worker as GTR admin to get the full list
        const r = await fetch(`${WORKER_BASE}/clients/options?cid=${encodeURIComponent(GTR_ID)}&v=1`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const options = await r.json();
        renderClientSelect(options, cid);
      } catch (err) {
        console.error("Error loading client options:", err);
        clientSelect.innerHTML = `<option value="${cid}">(failed to load)</option>`;
        clientSelect.disabled = false;
      }
    }

    async function loadSingleClientLabel(cid) {
      try {
        const r = await fetch(`${WORKER_BASE}/clients/label?cid=${encodeURIComponent(cid)}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const label = data.label || cid;
        clientSelect.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = cid;
        opt.textContent = label;
        clientSelect.appendChild(opt);
      } catch (err) {
        console.error("Error loading client label:", err);
      }
    }

    function renderClientSelect(options, currentCid) {
      if (!Array.isArray(options) || options.length === 0) {
        clientSelect.innerHTML = `<option value="${currentCid}">${currentCid}</option>`;
        clientSelect.disabled = false;
        return;
      }
      clientSelect.innerHTML =
        '<option value="">— Select client —</option>' +
        options.map(o => `
          <option value="${o.gtr_contact_id}" ${o.gtr_contact_id===currentCid?'selected':''}>
            ${o.client_label || o.gtr_contact_id}
          </option>
        `).join('');
      clientSelect.disabled = false;

      clientSelect.onchange = (e) => {
        const next = e.target.value;
        if (!next) return;
        const u = new URL(location.href);
        u.searchParams.set("cid", next);
        u.searchParams.set("admin", "1"); // keep admin on when switching
        location.href = u.toString();
      };
    }
  </script>
</body>
</html>
