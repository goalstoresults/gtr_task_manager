<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GTR Task Manager v1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f6f7f9;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .badge {
      background: #eef2ff;
      color: #3730a3;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 14px;
    }
    .btn {
      text-decoration: none;
      background: #111827;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
    }
    select {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="card">
    <strong>GTR Task Manager v1.1</strong>
    <span id="modeBadge" class="badge"></span>
    <label>Client</label>
    <select id="clientSelect"></select>
    <span id="clientBadge" class="badge"></span>
    <a id="addTaskBtn" class="btn" href="#">Add Task</a>
  </div>

  <script>
    // === CONFIG ===
    const GTR_ID = "hezFHREjxhfwcOdxYOcc";  
    const WORKER_BASE = "https://gtr-task-add.dennis-e64.workers.dev";

    // === STATE ===
    const url = new URL(window.location.href);
    const cid = (url.searchParams.get("cid") || "").trim();
    const isAdmin = cid === (GTR_ID || "").trim();

    const clientSelect = document.getElementById("clientSelect");
    const clientBadge = document.getElementById("clientBadge");
    const modeBadge = document.getElementById("modeBadge");
    const addTaskBtn = document.getElementById("addTaskBtn");

    if (isAdmin) {
      modeBadge.textContent = "Admin mode";
      loadClientOptions();
    } else {
      modeBadge.textContent = "Client view";
      loadSingleClientLabel(cid);
    }

    addTaskBtn.href = `${WORKER_BASE}/new?cid=${encodeURIComponent(cid)}`;

    // === FUNCTIONS ===
    async function loadClientOptions() {
      try {
        const r = await fetch(`${WORKER_BASE}/clients/options?cid=${encodeURIComponent(cid)}`);
        const options = await r.json();
        renderClientSelect(options, cid);
      } catch (err) {
        console.error("Error loading client options:", err);
      }
    }

    async function loadSingleClientLabel(cid) {
      try {
        const r = await fetch(`${WORKER_BASE}/clients/label?cid=${encodeURIComponent(cid)}`);
        const data = await r.json();
        const label = data.label || cid;
        clientSelect.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = cid;
        opt.textContent = label;  // show label, not ID
        clientSelect.appendChild(opt);
        clientSelect.disabled = true;
        clientBadge.textContent = label;
      } catch (err) {
        console.error("Error loading client label:", err);
      }
    }

    function renderClientSelect(options, currentCid) {
      clientSelect.innerHTML =
        '<option value="">— Select client —</option>' +
        options.map(o => `
          <option value="${o.gtr_contact_id}" ${o.gtr_contact_id===currentCid?'selected':''}>
            ${o.client_label || o.gtr_contact_id}
          </option>
        `).join('');
      clientSelect.disabled = false;
      const current = options.find(o => o.gtr_contact_id===currentCid);
      clientBadge.textContent = current ? current.client_label : currentCid;
    }
  </script>
</body>
</html>
