<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GTR Task Manager v1.7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background: #f6f7f9; margin: 0; padding: 20px; }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.1); display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .badge { background: #eef2ff; color: #3730a3; border-radius: 8px; padding: 4px 8px; font-size: 14px; }
    .link { color:#111827; text-decoration:none; border:1px solid #e5e7eb; padding:6px 10px; border-radius:8px; background:#fff; }
    select { padding: 6px; border-radius: 6px; border: 1px solid #ccc; }
    .spacer { flex: 1; }
    .panel { margin-top: 16px; }
    iframe { width: 100%; height: 72vh; border: 1px solid #e5e7eb; border-radius: 12px; background:#fff; }
  </style>
</head>
<body>
  <div class="card">
    <strong>GTR Task Manager v1.7</strong>
    <span id="modeBadge" class="badge"></span>

    <label>Client</label>
    <select id="clientSelect"></select>

    <label>View</label>
    <select id="viewSelect">
      <option value="active" selected>Active</option>
      <option value="attention">Attention</option>
      <!-- <option value="all">All</option> -->
    </select>

    <span class="spacer"></span>
    <a id="openFull" class="link" href="#" target="_blank" rel="noopener">Open Full</a>
  </div>

  <div class="panel">
    <iframe id="listFrame" src="about:blank"></iframe>
  </div>

  <script>
    // === CONFIG ===
    const GTR_ID = "hezFHREjxhfwcOdxYOcc"; // your admin CID
    const WORKER_BASE = "https://gtr-task-add.dennis-e64.workers.dev";

    // === STATE ===
    const url = new URL(window.location.href);
    const cid = (url.searchParams.get("cid") || "").trim();
    const adminFlag = url.searchParams.get("admin") === "1";
    const isAdmin = adminFlag || (cid === (GTR_ID || "").trim());

    // === ELEMENTS ===
    const clientSelect = document.getElementById("clientSelect");
    const viewSelect   = document.getElementById("viewSelect");
    const modeBadge    = document.getElementById("modeBadge");
    const listFrame    = document.getElementById("listFrame");
    const openFull     = document.getElementById("openFull");

    // === INIT ===
    if (!cid) {
      modeBadge.textContent = "Missing cid";
      clientSelect.innerHTML = '<option value="">(cid required in URL)</option>';
      clientSelect.disabled = true;
    } else if (isAdmin) {
      modeBadge.textContent = "Admin mode";
      loadClientOptions();
    } else {
      modeBadge.textContent = "Client view";
      loadSingleClientLabel(cid);
      clientSelect.disabled = true;
    }

    // initial load
    setListSrc();

    // events
    viewSelect.addEventListener("change", setListSrc);

    // === HELPERS ===
    function buildTasksUrl(view, cid, keepAdmin, embed=false) {
      const a = keepAdmin ? "&admin=1" : "";
      const e = embed ? "&embed=1" : "";
      return `${WORKER_BASE}/tasks?view=${encodeURIComponent(view)}&cid=${encodeURIComponent(cid)}${a}${e}`;
    }

    function setListSrc() {
      if (!cid) return;
      const view = viewSelect.value || "active";
      const src = buildTasksUrl(view, cid, isAdmin, /*embed*/ true);
      listFrame.src = src;
      openFull.href = buildTasksUrl(view, cid, isAdmin, /*embed*/ false);
    }

    async function loadClientOptions() {
      try {
        const r = await fetch(`${WORKER_BASE}/clients/options?cid=${encodeURIComponent(GTR_ID)}&v=1`);
        const options = await r.json();
        renderClientSelect(options, cid);
      } catch (err) {
        console.error(err);
        clientSelect.innerHTML = `<option value="${cid}">${cid}</option>`;
        clientSelect.disabled = false;
      }
    }

    async function loadSingleClientLabel(cid) {
      try {
        const r = await fetch(`${WORKER_BASE}/clients/label?cid=${encodeURIComponent(cid)}`);
        const data = await r.json();
        const label = data.label || cid;
        clientSelect.innerHTML = `<option value="${cid}">${label}</option>`;
      } catch (err) {
        console.error(err);
      }
    }

    function renderClientSelect(options, currentCid) {
      clientSelect.innerHTML =
        '<option value="">— Select client —</option>' +
        options.map(o => `
          <option value="${o.gtr_contact_id}" ${o.gtr_contact_id===currentCid?'selected':''}>
            ${o.client_label || o.gtr_contact_id}
          </option>
        `).join('');
      clientSelect.disabled = false;

      clientSelect.onchange = (e) => {
        const next = e.target.value;
        if (!next) return;
        const u = new URL(location.href);
        u.searchParams.set("cid", next);
        u.searchParams.set("admin", "1"); // keep admin on when switching
        location.href = u.toString();
      };
    }
  </script>
</body>
</html>
